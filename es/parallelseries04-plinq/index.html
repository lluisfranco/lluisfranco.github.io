<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Parallel Series 04 - PLINQ - &gt;_lluis franco</title>
        <meta name="Description" content="home/lluisfranco/code/tips/"><meta property="og:title" content="Parallel Series 04 - PLINQ" />
<meta property="og:description" content="Ir al índice de la serie
LINQ power! Creo que estaremos todos de acuerdo en que LINQ ha supuesto una revolución en la forma de desarrollar, y ha hecho que muchos desarrolladores de otros lenguajes nos miren con cierto tono de envidia… E incluso que otras plataformas estén haciendo serios esfuerzos para incorporarlo en sus Frameworks :-)
Ahora, con la llegada de la Task Parallel Library, se abre un mundo de posibilidades gracias a PLINQ, que permite -de forma extremadamente sencilla- convertir cualquier consulta LINQ secuencial en una consulta paralelizable, permitiendo su segmentación y ejecución en los distintos cores en paralelo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lluisfranco.github.io/es/parallelseries04-plinq/" />
<meta property="article:published_time" content="2011-05-31T11:51:50+02:00" />
<meta property="article:modified_time" content="2011-05-31T11:51:50+02:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Parallel Series 04 - PLINQ"/>
<meta name="twitter:description" content="Ir al índice de la serie
LINQ power! Creo que estaremos todos de acuerdo en que LINQ ha supuesto una revolución en la forma de desarrollar, y ha hecho que muchos desarrolladores de otros lenguajes nos miren con cierto tono de envidia… E incluso que otras plataformas estén haciendo serios esfuerzos para incorporarlo en sus Frameworks :-)
Ahora, con la llegada de la Task Parallel Library, se abre un mundo de posibilidades gracias a PLINQ, que permite -de forma extremadamente sencilla- convertir cualquier consulta LINQ secuencial en una consulta paralelizable, permitiendo su segmentación y ejecución en los distintos cores en paralelo."/>
<meta name="application-name" content="&gt;_lluis franco">
<meta name="apple-mobile-web-app-title" content="&gt;_lluis franco"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/myAvatar.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://lluisfranco.github.io/es/parallelseries04-plinq/" /><link rel="prev" href="https://lluisfranco.github.io/es/parallelseries03-conceptos-base/" /><link rel="next" href="https://lluisfranco.github.io/es/luces-camara-action/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.es.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Parallel Series 04 - PLINQ",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/lluisfranco.github.io\/es\/parallelseries04-plinq\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/lluisfranco.github.io\/images\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "csharp, net framework, Task, Parallel, Async","wordcount":  1461 ,
        "url": "https:\/\/lluisfranco.github.io\/es\/parallelseries04-plinq\/","datePublished": "2011-05-31T11:51:50+02:00","dateModified": "2011-05-31T11:51:50+02:00","publisher": {
                "@type": "Organization",
                "name": "Lluis Franco",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/lluisfranco.github.io\/images\/myAvatar200.png",
                "width":  127 ,
                "height":  40 
                }
            },"author": {
                "@type": "Person",
                "name": "lluís"
            },"description": ""
    }
    </script></head>
    <body><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/es/" title="&gt;_lluis franco"><span class="header-title-pre"><i class='fas fa-terminal'></i></span>lluis franco</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/es/about/"> About </a><a class="menu-item" href="/es/posts/"> Posts </a><a class="menu-item" href="/es/tags/"> Tags </a><a class="menu-item" href="/es/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Selecciona el lenguage">Spanish<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/es/parallelseries04-plinq/" selected>Spanish</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Busca títulos o contenido..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Buscar">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Limpiar">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/es/" title="&gt;_lluis franco"><span class="header-title-pre"><i class='fas fa-terminal'></i></span>lluis franco</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Busca títulos o contenido..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Buscar">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Limpiar">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancelar
                    </a>
                </div><a class="menu-item" href="/es/about/" title="">About</a><a class="menu-item" href="/es/posts/" title="">Posts</a><a class="menu-item" href="/es/tags/" title="">Tags</a><a class="menu-item" href="/es/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Selecciona el lenguage">Spanish<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/es/parallelseries04-plinq/" selected>Spanish</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contenido</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Parallel Series 04 - PLINQ</h1><h2 class="single-subtitle">Parallel LINQ</h2><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/about/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>lluís</a></span>&nbsp;
                    <span class="post-category">incluido en<a href="/es/categories/development/">
                                <i class="far fa-folder fa-fw"></i>Development
                            </a>&nbsp;<a href="/es/categories/parallel-series/">
                                <i class="far fa-folder fa-fw"></i>Parallel Series
                            </a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2011-05-31>2011-05-31</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>unas 1461 palabras&nbsp;
                <i class="far fa-clock fa-fw"></i>7 min&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading/normal.min.svg"
        data-src="/images/posts/PLINQ.png"
        data-srcset="/images/posts/PLINQ.png, /images/posts/PLINQ.png 1.5x, /images/posts/PLINQ.png 2x"
        data-sizes="auto"
        alt="/images/posts/PLINQ.png"
        title="/images/posts/PLINQ.png" /></div><div class="details toc" id="toc-static">
                <div class="details-summary toc-title">
                    <span>Contenido</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#linq-power">LINQ power!</a>
      <ul>
        <li><a href="#dónde-está-la-magia">¿Dónde está la magia?</a></li>
        <li><a href="#plinq-y-la-ordenación">PLINQ y la ordenación</a></li>
        <li><a href="#especificar-el-grado-de-paralelización">Especificar el grado de paralelización</a></li>
        <li><a href="#cancelación-de-una-consulta-plinq">Cancelación de una consulta PLINQ</a></li>
        <li><a href="#limitaciones-de-plinq">Limitaciones de PLINQ</a></li>
      </ul>
    </li>
    <li><a href="#video">Video</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><a href="/es/parallelseries00-index" rel="">Ir al índice de la serie</a></p>
<h2 id="linq-power">LINQ power!</h2>
<p>Creo que estaremos todos de acuerdo en que LINQ ha supuesto una revolución en la forma de desarrollar, y ha hecho que muchos desarrolladores de otros lenguajes nos miren con cierto tono de envidia… E incluso que otras plataformas estén haciendo serios esfuerzos para incorporarlo en sus Frameworks :-)</p>
<p>Ahora, con la llegada de la <a href="http://msdn.microsoft.com/en-us/library/dd460693.aspx" target="_blank" rel="noopener noreffer">Task Parallel Library</a>, se abre un mundo de posibilidades gracias a PLINQ, que permite -de forma extremadamente sencilla- convertir cualquier consulta LINQ secuencial en una consulta paralelizable, permitiendo su segmentación y ejecución en los distintos cores en paralelo.</p>
<p>Es decir cualquier consulta LINQ, cómo la siguiente, en la que tenemos un array llamado numbers y un método IsPrime que devuelve un valor boolean en función de si un número es primo.</p>
<p>Suponiendo esta función que devuelve si un número es primo:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="n">IsPrime</span><span class="p">(</span><span class="k">this</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="c1">//1 = false, 2 = true, 3 = true...
</span><span class="c1"></span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="p">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="p">&amp;</span> <span class="m">1</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="p">==</span> <span class="m">2</span><span class="p">)</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="p">*</span> <span class="n">i</span><span class="p">)</span> <span class="p">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span> <span class="p">+=</span> <span class="m">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="p">%</span> <span class="n">i</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">n</span> <span class="p">!=</span> <span class="m">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>Puede ser ejecutada con LINQ de este modo para que retorne sólo aquellos números que son primos:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">query</span> <span class="p">=</span>
    <span class="k">from</span> <span class="n">n</span> <span class="k">in</span> <span class="n">numbers</span>
    <span class="k">where</span> <span class="n">n</span><span class="p">.</span><span class="n">IsPrime</span><span class="p">()</span>
    <span class="k">select</span> <span class="n">n</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div>
<p>Y ésta ser paralelizada simplemente agregando <strong>AsParallel</strong> de este modo:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="hl"><span class="lnt">2
</span></span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">query</span> <span class="p">=</span>
<span class="hl">    <span class="k">from</span> <span class="n">n</span> <span class="k">in</span> <span class="n">numbers</span><span class="p">.</span><span class="n">AsParallel</span><span class="p">()</span>
</span>    <span class="k">where</span> <span class="n">n</span><span class="p">.</span><span class="n">IsPrime</span><span class="p">()</span>
    <span class="k">select</span> <span class="n">n</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div>
<p>Partiendo de que el array de números contiene los  primeros 10 millones de números enteros, y de que mi estación de trabajo actual tiene un procesador i7 con 8 cores, el resultado es abrumador:</p>
<p>La consulta LINQ tarda  5,2 segundos frente a los 1,3 segundos de la segunda.</p>
<p>Es decir, casi 4 segundos menos o un 400% más rápido.
Nada mal, eh?</p>
<h3 id="dónde-está-la-magia">¿Dónde está la magia?</h3>
<p>La magia verdadera es que PLINQ nos abstrae de todo el proceso de paralelización, creación de tareas, threads, sincronización y consolidación de los datos.</p>
<p>Y además creo que lo hace de forma muy elegante :-)</p>
<p>Como ya sabemos, las consultas LINQ se basan en <a href="http://msdn.microsoft.com/en-us/library/9eekhta0.aspx" target="_blank" rel="noopener noreffer">IEnumerable<T></a> (gracias Generics!) que expone un enumerador para recorrer los elementos de una secuencia de elementos de tipo T. Esto hace que todas las colecciones que puedan devolverse en este tipo de consultas (IOrderedEnumerable, IQueryable, etc.) implementen esta interfaz. Hasta aquí nada nuevo bajo el sol.</p>
<p>Sin embargo, en la consulta PLINQ al utilizar el método extensor <a href="http://msdn.microsoft.com/en-us/library/dd413602.aspx" target="_blank" rel="noopener noreffer">AsParallel()</a> estamos transformando la secuencia de entrada de <a href="http://msdn.microsoft.com/en-us/library/9eekhta0.aspx" target="_blank" rel="noopener noreffer">IEnumerable<T></a> a <a href="http://msdn.microsoft.com/en-us/library/dd383736.aspx" target="_blank" rel="noopener noreffer">ParallelQuery <T></a> permitiendo la segmentación de los elementos de la secuencia y ejecutando cada uno de los segmentos en un thread distinto. Y por supuesto, repartiendo el trabajo en los diversos cores (si los hay).</p>
<figure>
    <img src="/images/posts/asparallel.png"/> <figcaption>
            <h4>Segmentación en paralelo de la secuencia</h4>
        </figcaption>
</figure>

<p>La secuencia de entrada se particiona y se manda por fragmentos a distintos threads que invocan al método IsPrime devolviendo true (T) o false (F), y posteriormente los consolida en una secuencia de salida que puede ser consumida.</p>
<p>No obstante, el hecho de paralelizar el trabajo no garantiza que el resultado sea devuelto en el mismo orden, ya que es posible que un thread termine antes que otro y devuelva su resultado parcial antes de lo esperado. Así que, si la ordenación de los datos de salida es importante tenemos que ir un paso más allá.</p>
<figure>
    <img src="/images/posts/asordered.png"/> <figcaption>
            <h4>Los primeros elementos deberían ser 2, 3, 5, 7… no 59 y 71 ¿?</h4>
        </figcaption>
</figure>

<h3 id="plinq-y-la-ordenación">PLINQ y la ordenación</h3>
<p>Para asegurar la ordenación del conjunto de resultados, basta agregar el método AsOrdered() a la consulta. Este método asegura la correcta ordenación, a costa de implementar una serie de mecanismos de sincronización. Estos mecanismos, lógicamente retardan un poco el tiempo de entrega de los resultados, pero es despreciable. En mi estación de trabajo se arrojan unos valores de 1,311 segundos sin ordenar frente a 1,344 segundos ordenados (apenas 30 milésimas). Estos resultados son la media de una serie de 50 mediciones, con lo que son bastante fiables.</p>
<p>Una vez modificada la consulta:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="hl"><span class="lnt">2
</span></span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">query</span> <span class="p">=</span>
<span class="hl">    <span class="k">from</span> <span class="n">n</span> <span class="k">in</span> <span class="n">numbers</span><span class="p">.</span><span class="n">AsParallel</span><span class="p">().</span><span class="n">AsOrdered</span><span class="p">()</span>
</span>    <span class="k">where</span> <span class="n">n</span><span class="p">.</span><span class="n">IsPrime</span><span class="p">()</span>
    <span class="k">select</span> <span class="n">n</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div>
<figure>
    <img src="/images/posts/asordered2.png"/> <figcaption>
            <h4>Ahora si están ordenados :)</h4>
        </figcaption>
</figure>

<h3 id="especificar-el-grado-de-paralelización">Especificar el grado de paralelización</h3>
<p>En la mayoría de las charlas que he dado sobre la TPL se acostumbra a preguntar respecto a funciones que acceden a recursos externos (servicios, sockets, etc.). En estos casos aparece claramente un cuello de botella, y no porque una función necesite hacer uso intensivo de la CPU, sino porque debe esperar un resultado externo. Aquí suele ser interesante especificar el grado de paralelización de deseamos. Otro caso interesante para especificar el grado de paralelización puede ser el típico escenario de <a href="https://docs.microsoft.com/es-es/previous-versions/visualstudio/visual-studio-2008/yy12yx1f%28v=vs.90%29?redirectedfrom=MSDN" target="_blank" rel="noopener noreffer">productor/consumidor</a>.</p>
<p>Es interesante notar que al especificar el grado de paralelización no estamos forzando a que se usen n particiones, sino que simplemente estamos especificando el valor máximo:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="hl"><span class="lnt">4
</span></span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">cores</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">query</span> <span class="p">=</span>
    <span class="k">from</span> <span class="n">n</span> <span class="k">in</span> <span class="n">numbers</span><span class="p">.</span><span class="n">AsParallel</span><span class="p">().</span><span class="n">AsOrdered</span><span class="p">().</span>
<span class="hl">        <span class="n">WithDegreeOfParallelism</span><span class="p">(</span><span class="n">cores</span> <span class="p">/</span> <span class="m">2</span><span class="p">)</span>
</span>    <span class="k">where</span> <span class="n">n</span><span class="p">.</span><span class="n">IsPrime</span><span class="p">()</span>
    <span class="k">select</span> <span class="n">n</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div>
<p>De este modo, al definir el grado de paralelización en la mitad del número de cores del procesador nos aseguramos que (por ejemplo) podremos tener un hilo que vaya creando elementos (productor) y otro hilo que vaya consumiendo dichos elementos (consumidor).</p>
<h3 id="cancelación-de-una-consulta-plinq">Cancelación de una consulta PLINQ</h3>
<p>En ocasiones, una consulta PLINQ puede ser cancelada. Bien porque durante el proceso se ha encontrado un error y ya no es necesario terminar de calcular el resto de resultados, o simplemente porque ha sido cancelada por el usuario.</p>
<p>Es estos casos, es necesario utilizar un token de cancelación. Este token tiene su origen en la estructura <a href="http://blogs.msdn.com/b/pfxteam/archive/2009/05/22/9635790.aspx" target="_blank" rel="noopener noreffer">CancellationTokenSource</a>, que representa ‘una potencial cancelación’ y proporciona los mecanismos para cancelar y comprobar el estado de una tarea asíncrona, de modo que puede utilizarse con todos los elementos de la Task Parallel Library, no sólo con PLINQ.</p>
<p>A continuación, vamos a modificar el código del ejemplo que hemos usado hasta ahora para simular un error y comprobar el funcionamiento de la cancelación de tareas en PLINQ. Para ello lo primero que vamos a hacer es crear una sobrecarga del método IsPrime, que reciba un parámetro de tipo CancellationTokenSource, para poder cancelar la tarea:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="n">IsPrime</span><span class="p">(</span><span class="k">this</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">CancellationTokenSource</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="p">==</span> <span class="m">1000</span><span class="p">)</span> <span class="n">cs</span><span class="p">.</span><span class="n">Cancel</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">IsPrime</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>A modo de ejemplo, cuando el número a calcular sea 1.000 cancelaremos la tarea, de modo que no sea necesario llegar a los 10 millones. De este modo, por un lado se lanzará una excepción y por otro el tiempo en ejecutar la consulta PLINQ será mucho menor.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="hl"><span class="lnt">12
</span></span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">void</span> <span class="n">plinq_cancellable</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">10000000</span><span class="p">);</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">clock</span> <span class="p">=</span> <span class="n">Stopwatch</span><span class="p">.</span><span class="n">StartNew</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="n">numbers</span><span class="p">.</span><span class="n">AsParallel</span><span class="p">().</span><span class="n">AsOrdered</span><span class="p">().</span>
            <span class="n">WithCancellation</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">Token</span><span class="p">).</span>
            <span class="n">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">IsPrime</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
        <span class="k">try</span>
        <span class="p">{</span>
<span class="hl">            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">query</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span>        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">clock</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">clock</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="s">&#34;n2&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>Por un lado tenemos que tener la precaución de envolver la consulta dentro de un bloque try-catch (en este caso sólo la llamada a ToArray() que es realmente cuando se ejecuta la consulta), y por el otro especificamos que la consulta puede ser cancelada mediante <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.threading.threadingtools.withcancellation?view=visualstudiosdk-2019" target="_blank" rel="noopener noreffer">WithCancellation</a>.</p>
<p>A continuación creamos un objeto de tipo <a href="http://blogs.msdn.com/b/pfxteam/archive/2009/05/22/9635790.aspx" target="_blank" rel="noopener noreffer">CancellationTokenSource</a> para administrar la cancelación de esta consulta. Este objeto será el que finalmente pasemos al método IsPrime() y en caso que se cancele provocará que su propiedad <a href="http://msdn.microsoft.com/en-us/library/system.threading.cancellationtoken.iscancellationrequested.aspx" target="_blank" rel="noopener noreffer">IsCancellationRequested</a> devuelva true y que se produzca una bonita excepción de tipo <a href="http://msdn.microsoft.com/en-us/library/system.operationcanceledexception%28v=vs.80%29.aspx" target="_blank" rel="noopener noreffer">OperationCanceledException</a>.</p>
<figure>
    <img src="/images/posts/withcancellation.png"/> <figcaption>
            <h4>Al llegar a 1000... boom!</h4>
        </figcaption>
</figure>

<h3 id="limitaciones-de-plinq">Limitaciones de PLINQ</h3>
<p>No quiero extenderme mucho más porque creo que hay material suficiente para hacer un post más adelante sobre temas avanzados. Sin embargo quiero dejar claro que existen algunas limitaciones en PLINQ, como el uso de algunos operadores (Take, SkipWhile) y de las versiones indexadas de Select o ElementAt.</p>
<p>Además existen otros casos en los que por cuestiones de rendimiento no es recomendable usar PLINQ en todos los casos, debido al sobrecoste que puede llegar a ocasionar, como el uso de Join, Union o GroupBy. Sin embargo, trataremos éstas cuestiones más adelante.</p>
<p>Próximamente veremos cómo utilizar la clase estática Parallel, optimizada para trabajar con procesos iterativos, esos típicos bucles que todas las aplicaciones tienen.</p>
<h2 id="video">Video</h2>
<p>Aquí tienes un vídeo corto (15 minutos) sobre lo que acabamos de contar ;)</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://player.vimeo.com/video/32231145" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="vimeo video" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
 </div>

<p>A continución&hellip;</p>
<p>En el <a href="/es/parallelseries05/" rel="">próximo post</a> veremos cómo utilizar la clase estática Parallel, optimizada para trabajar con procesos iterativos, esos típicos bucles que todas las aplicaciones tienen.</p>
<p><a href="/es/parallelseries00-index" rel="">Ir al índice de la serie</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>El artículo fue actualizado el 2011-05-31</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/es/parallelseries04-plinq/index.md" target="_blank">Leer Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Compartir en Twitter" data-sharer="twitter" data-url="https://lluisfranco.github.io/es/parallelseries04-plinq/" data-title="Parallel Series 04 - PLINQ" data-via="lluisfranco" data-hashtags="csharp,net framework,Task,Parallel,Async"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Facebook" data-sharer="facebook" data-url="https://lluisfranco.github.io/es/parallelseries04-plinq/" data-hashtag="csharp"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Linkedin" data-sharer="linkedin" data-url="https://lluisfranco.github.io/es/parallelseries04-plinq/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en WhatsApp" data-sharer="whatsapp" data-url="https://lluisfranco.github.io/es/parallelseries04-plinq/" data-title="Parallel Series 04 - PLINQ" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Pinterest" data-sharer="pinterest" data-url="https://lluisfranco.github.io/es/parallelseries04-plinq/" data-image="/images/posts/PLINQ.png"><i class="fab fa-pinterest fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Reddit" data-sharer="reddit" data-url="https://lluisfranco.github.io/es/parallelseries04-plinq/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Instapaper" data-sharer="instapaper" data-url="https://lluisfranco.github.io/es/parallelseries04-plinq/" data-title="Parallel Series 04 - PLINQ" data-description=""><i data-svg-src="/lib/simple-icons/icons/instapaper.min.svg"></i></a><a href="javascript:void(0);" title="Compartir en Pocket" data-sharer="pocket" data-url="https://lluisfranco.github.io/es/parallelseries04-plinq/"><i class="fab fa-get-pocket fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Evernote" data-sharer="evernote" data-url="https://lluisfranco.github.io/es/parallelseries04-plinq/" data-title="Parallel Series 04 - PLINQ"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/es/tags/csharp/">csharp</a>,&nbsp;<a href="/es/tags/net-framework/">net framework</a>,&nbsp;<a href="/es/tags/task/">Task</a>,&nbsp;<a href="/es/tags/parallel/">Parallel</a>,&nbsp;<a href="/es/tags/async/">Async</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Regresar</a></span>&nbsp;|&nbsp;<span><a href="/es/">Inicio</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/es/parallelseries03-conceptos-base/" class="prev" rel="prev" title="Parallel Series 03 - Conceptos base"><i class="fas fa-angle-left fa-fw"></i>Parallel Series 03 - Conceptos base</a>
            <a href="/es/luces-camara-action/" class="next" rel="next" title="Luces, cámara... action!">Luces, cámara... action!<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/about/" target="_blank">lluís</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Volver arriba">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="Ver comentarios">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript">
    window.config = {"code":{"copyTitle":"Copiar al portapapeles","maxShownLines":20},"comment":{},"headerMode":{"desktop":"fixed","mobile":"auto"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/es/index.json","lunrLanguageCode":"es","maxResultLength":10,"noResultsFound":"No se encontraron resultados","snippetLength":30,"type":"lunr"}};
</script><script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=html5shiv%2CElement.prototype.closest%2CrequestAnimationFrame%2CCustomEvent%2CPromise%2CObject.entries%2CObject.assign%2CObject.values%2Cfetch%2CElement.prototype.after%2CArray.prototype.fill%2CIntersectionObserver%2CArray.from%2CArray.prototype.find%2CMath.sign"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.es.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/object-fit-images/ofi.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
