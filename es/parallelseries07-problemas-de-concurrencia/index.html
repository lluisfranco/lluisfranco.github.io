<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Parallel Series 07 - Problemas de concurrencia - &gt;_lluis franco</title><meta name="Description" content="home/lluisfranco/code/tips/"><meta property="og:title" content="Parallel Series 07 - Problemas de concurrencia" />
<meta property="og:description" content="Ir al índice de la serie
Las nuevas Concurrent Collections En un mundo en el que los procesos ya no son secuenciales sino paralelos, es cada vez más posible encontrarnos con problemas de concurrencia al acceder a recursos compartidos. Conceptualmente hablando, esto es algo a los que los desarrolladores ya estamos acostumbrados cuando trabajamos con gestores de bases de datos como Oracle o SQL Server, ya que varios usuarios pueden acceder o modificar la información al mismo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/" />
<meta property="article:published_time" content="2013-03-01T11:51:50+02:00" />
<meta property="article:modified_time" content="2013-03-01T11:51:50+02:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Parallel Series 07 - Problemas de concurrencia"/>
<meta name="twitter:description" content="Ir al índice de la serie
Las nuevas Concurrent Collections En un mundo en el que los procesos ya no son secuenciales sino paralelos, es cada vez más posible encontrarnos con problemas de concurrencia al acceder a recursos compartidos. Conceptualmente hablando, esto es algo a los que los desarrolladores ya estamos acostumbrados cuando trabajamos con gestores de bases de datos como Oracle o SQL Server, ya que varios usuarios pueden acceder o modificar la información al mismo."/>
<meta name="application-name" content="&gt;_lluis franco">
<meta name="apple-mobile-web-app-title" content="&gt;_lluis franco"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/myAvatar.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/" /><link rel="prev" href="https://lluisfranco.com/es/parallelseries06-task-class/" /><link rel="next" href="https://lluisfranco.com/es/dotnet-spain-conference-2015/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Parallel Series 07 - Problemas de concurrencia",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/lluisfranco.com\/es\/parallelseries07-problemas-de-concurrencia\/"
        },"genre": "posts","keywords": "csharp, net framework, Task, Parallel, Async","wordcount":  1732 ,
        "url": "https:\/\/lluisfranco.com\/es\/parallelseries07-problemas-de-concurrencia\/","datePublished": "2013-03-01T11:51:50+02:00","dateModified": "2013-03-01T11:51:50+02:00","publisher": {
            "@type": "Organization",
            "name": "Lluis Franco"},"author": {
                "@type": "Person",
                "name": "lluís"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/es/" title="&gt;_lluis franco"><span class="header-title-pre"><i class='fas fa-terminal'></i></span>lluis franco</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/es/about/"> About </a><a class="menu-item" href="/es/posts/"> Posts </a><a class="menu-item" href="/es/tags/"> Tags </a><a class="menu-item" href="/es/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Selecciona el lenguage">Spanish<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/es/parallelseries07-problemas-de-concurrencia/" selected>Spanish</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Busca títulos o contenido..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Buscar">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Limpiar">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/es/" title="&gt;_lluis franco"><span class="header-title-pre"><i class='fas fa-terminal'></i></span>lluis franco</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Busca títulos o contenido..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Buscar">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Limpiar">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancelar
                    </a>
                </div><a class="menu-item" href="/es/about/" title="">About</a><a class="menu-item" href="/es/posts/" title="">Posts</a><a class="menu-item" href="/es/tags/" title="">Tags</a><a class="menu-item" href="/es/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Selecciona el lenguage">Spanish<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/es/parallelseries07-problemas-de-concurrencia/" selected>Spanish</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contenido</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Parallel Series 07 - Problemas de concurrencia</h1><h2 class="single-subtitle">Cuando los threads luchan por acceder a los mismos recursos</h2><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/about/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>lluís</a></span>&nbsp;<span class="post-category">incluido en <a href="/es/categories/development/"><i class="far fa-folder fa-fw"></i>Development</a>&nbsp;<a href="/es/categories/parallel-series/"><i class="far fa-folder fa-fw"></i>Parallel Series</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2013-03-01">2013-03-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1732 palabras&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;9 minutos&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/posts/Concurrence.png"
        data-srcset="/images/posts/Concurrence.png, /images/posts/Concurrence.png 1.5x, /images/posts/Concurrence.png 2x"
        data-sizes="auto"
        alt="/images/posts/Concurrence.png"
        title="/images/posts/Concurrence.png" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contenido</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#las-nuevas-concurrent-collections">Las nuevas Concurrent Collections</a>
      <ul>
        <li><a href="#un-escenario-real">Un escenario real</a>
          <ul>
            <li><a href="#paso-1--definir-una-clase-customer">Paso 1 – Definir una Clase Customer</a></li>
            <li><a href="#paso-2--crear-un-dictionary">Paso 2 – Crear un Dictionary</a></li>
            <li><a href="#paso-3--crear-100000-clientes-de-ejemplo">Paso 3 – Crear 100.000 clientes de ejemplo</a></li>
            <li><a href="#paso-4--definir-2-métodos-que-compitan-entre-si">Paso 4 – Definir 2 métodos que compitan entre si</a></li>
            <li><a href="#paso-5---a-jugar-">Paso 5 - A jugar :)</a></li>
          </ul>
        </li>
        <li><a href="#la-nueva-clase-concurrentdictionary">La nueva clase ConcurrentDictionary</a></li>
        <li><a href="#arreglando-el-ejemplo-anterior-">Arreglando el ejemplo anterior :)</a>
          <ul>
            <li><a href="#paso-1--cambiamos-dictionary-por-concurrentdictionary">Paso 1 – Cambiamos Dictionary por ConcurrentDictionary</a></li>
            <li><a href="#paso-2---creamos-100000-clientes-de-ejemplo">Paso 2 - Creamos 100.000 clientes de ejemplo</a></li>
            <li><a href="#paso-3---modificamos-los-2-métodos-que-compiten">Paso 3 - Modificamos los 2 métodos que compiten</a></li>
            <li><a href="#paso-4---a-jugar-de-nuevo-d">Paso 4 - A jugar de nuevo :D</a></li>
          </ul>
        </li>
        <li><a href="#conclusión">Conclusión</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><a href="/es/parallelseries00-index" rel="">Ir al índice de la serie</a></p>
<h2 id="las-nuevas-concurrent-collections">Las nuevas Concurrent Collections</h2>
<p>En un mundo en el que los procesos ya no son secuenciales sino paralelos, es cada vez más posible encontrarnos con problemas de concurrencia al acceder a recursos compartidos. Conceptualmente hablando, esto es algo a los que los desarrolladores ya estamos acostumbrados cuando trabajamos con gestores de bases de datos como Oracle o SQL Server, ya que varios usuarios pueden acceder o modificar la información al mismo.</p>
<p>Sin embargo, la gran mayoría de los desarrolladores pocas veces hemos tenido que lidiar con bloqueos en colecciones en menoria, ya que no todo el mundo crea aplicaciones en las que varios threads acceden a recursos compartidos. De hecho, si alguna vez has lo tenido que hacer sabrás perfectamente que antes de la aparición de la TPL era una de las disciplinas más complejas dentro del desarrollo de software, casi tanto como nombrar bien las cosas (*). Es algo que favorece la calvície, y créeme, lo digo por experiencia :)</p>
<blockquote>
<p>(*) There are only two hard things in Computer Science: cache invalidation and naming things.</p>
</blockquote>
<p>Sin embargo, desde la aparición de la TPL en el .NET Framework 4.0 es mucho más sencillo desarrollar aplicaciones que ejecuten procesos en paralelo o de forma asíncrona, pero esto conlleva que en ocasiones nos olvidemos que hay algunos threads que se ejecutan al mismo tiempo, y esto podría llevar a producir efectos no deseados cuando se trata de acceder a recursos compartidos, como una colección de elementos en memoria.</p>
<p>Por ejemplo: supongamos un escenario en el que tenemos una lista de clientes en memoria y un par de tareas (Task) que acceden a esa colección. La primera tarea podría estar verificando si todos los clientes cumplen una condición X, y si no la cumplen eliminar el cliente de la colección. Mientras tanto la segunda tarea podría estar actualizando alguna propiedad de los clientes, como la edad.</p>
<h3 id="un-escenario-real">Un escenario real</h3>
<p>Encierra este escenario algún peligro? A priori podemos pensar que no. Basta con que la segunda tarea verifique si el cliente existe en la colección antes de actualizarlo. Seguro? Pues no. Al menos no basta si la colección que estamos usando no es una de las nuevas definidas dentro del namespace System.Collections.Concurrent. Y para verlo mejor, hagamos un pequeño ejemplo con código, que es lo que nos gusta a todos.</p>
<h4 id="paso-1--definir-una-clase-customer">Paso 1 – Definir una Clase Customer</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Customer</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">CustomerId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Age</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="n">GetSampleCustomers</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Random</span> <span class="n">r</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">(</span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">GetHashCode</span><span class="p">());</span>
        <span class="n">List</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="n">customers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">customers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Customer</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">CustomerId</span> <span class="p">=</span> <span class="n">i</span><span class="p">,</span>
                <span class="n">Name</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&#34;Customer {0}&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                <span class="n">Age</span> <span class="p">=</span> <span class="n">r</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="m">20</span><span class="p">,</span> <span class="m">80</span><span class="p">)</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">customers</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h4 id="paso-2--crear-un-dictionary">Paso 2 – Crear un Dictionary</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Customer</span><span class="p">&gt;</span> <span class="n">dic1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">Customer</span><span class="p">&gt;();</span>
</code></pre></td></tr></table>
</div>
</div>
<h4 id="paso-3--crear-100000-clientes-de-ejemplo">Paso 3 – Crear 100.000 clientes de ejemplo</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">dic1</span> <span class="p">=</span> <span class="n">Customer</span><span class="p">.</span><span class="n">GetSampleCustomers</span><span class="p">(</span><span class="m">100000</span><span class="p">).</span><span class="n">ToDictionary</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">CustomerId</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div>
<h4 id="paso-4--definir-2-métodos-que-compitan-entre-si">Paso 4 – Definir 2 métodos que compitan entre si</h4>
<p>Ahora, vamos a complicar un poco más el ejemplo y crearemos dos métodos que simulen el borrado y la actualización de los objetos que contiene la colección. Luego llamaremos a éstos métodos para 100 objetos aleatorios de forma paralela para ver que efectos se producen</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">void</span> <span class="n">DeleteItem1</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dic1</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">dic1</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Age</span> <span class="p">&lt;</span> <span class="m">30</span><span class="p">)</span> <span class="n">dic1</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="n">UpdateItem1</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dic1</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="n">dic1</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Age</span><span class="p">++;</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="n">button1_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">Random</span> <span class="n">r</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">(</span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">GetHashCode</span><span class="p">());</span>
        <span class="kt">int</span> <span class="n">id</span> <span class="p">=</span> <span class="n">r</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">dic1</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
        <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">DeleteItem1</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
        <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">UpdateItem1</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h4 id="paso-5---a-jugar-">Paso 5 - A jugar :)</h4>
<p>Ejecutamos nuestra aplicación y si se produce una colisión puede pasar que obtengamos un bonito error como este, en el que básicamente se intenta acceder a un elemento de la colección que ya no existe (Si no se produce a la primera, repite la prueba hasta que lo veas).</p>
<p>Y digo que puede pasar, pero no es seguro. Tal vez tengamos que repetir el proceso varias veces, y es que en un entorno en el que varios threads acceden a un recurso compartido nada nos asegura que se produzca el error. A veces pasa a la primera y a veces a la cuarta, pero hay que tener presente que cuando esté en producción siempre pasará en viernes por la tarde cinco minutos antes de empezar el fin de semana ;)</p>
<figure>
    <img src="/images/posts/ExceptionKeyNotFoundInCollection.png"/> <figcaption>
            <h4>Error al intentar acceder a una cliente que ya no existe</h4>
        </figcaption>
</figure>

<p>Concretamente en la línea que incrementa la edad del cliente:</p>
<figure>
    <img src="/images/posts/ExceptionKeyNotFoundInCollectionCode.png"/> <figcaption>
            <h4>¿Pero cómo puede pasar esto?</h4>
        </figcaption>
</figure>

<p>Analicemos el porqué del error: ¿cómo es posible que no encuentre el elemento en la colección si precisamente en la línea anterior verificamos su existencia? Pues ahí está la gracia, que lo verificamos en la línea anterior. A nosotros -pobres developers- nos parece que la línea anterior en la que verificamos si existe y la línea siguiente en la que lo eliminamos van seguidas una detrás de otra, pero realmente <strong>en un entorno asíncrono hay todo un mundo entre ambas</strong>. Y eso es porque ambas líneas se ejecutan de forma separada, sin ningún tipo de bloqueo, no existe Transaccionalidad al estilo de las bases de datos, de modo que mientras el primer thread verifica que existe ese elemento en la colección y lo borra, llega el segundo thread y… ZASCA! Lo elimina.</p>
<figure>
    <img src="/images/posts/ConcurrentCollections_Dictionary.png"/> <figcaption>
            <h4>Esta es la explicación...</h4>
        </figcaption>
</figure>

<h3 id="la-nueva-clase-concurrentdictionary">La nueva clase ConcurrentDictionary</h3>
<p>Para lidiar con estos casos aparecen en escena un nuevo conjunto de colecciones especializadas en entornos multithreading. Una de las más populares es una variación del clásico Dictionary, el ConcurrentDictionary. Esta clase proporciona una série de métodos alternativos para agregar, modificar o eliminar elementos llamados TryAdd, TryUpdate o TryRemove. La ventaja de éstos métodos es que son transaccionales y proporcionan <a href="http://en.wikipedia.org/wiki/Atomicity_%28database_systems%29" target="_blank" rel="noopener noreffer">Atomicidad</a>. Es decir, garantizan que en caso de que se invoquen, se ejecuten totalmente: O bien se añade/modifica/elimina el elemento de la colección o bien se devuelve el valor False porque no se ha podido realizar la operación. También proporciona un método TryGetValue que intenta obtener un elemento de la colección. Todos estos métodos implementan en su interior bloqueos (<a href="http://msdn.microsoft.com/en-us/library/c5kehkcz%28v=vs.71%29.aspx" target="_blank" rel="noopener noreffer">lock</a>), para asegurar que nadie más accede al elemento mientras se realiza la operación solicitada.</p>
<h3 id="arreglando-el-ejemplo-anterior-">Arreglando el ejemplo anterior :)</h3>
<p>Vamos a modificar el ejemplo anterior usando esta nueva colección, para observar su comportamiento en el entorno anterior.</p>
<h4 id="paso-1--cambiamos-dictionary-por-concurrentdictionary">Paso 1 – Cambiamos Dictionary por ConcurrentDictionary</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Customer</span><span class="p">&gt;</span> <span class="n">dic2</span> <span class="p">=</span>
    <span class="k">new</span> <span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Customer</span><span class="p">&gt;();</span>
</code></pre></td></tr></table>
</div>
</div>
<h4 id="paso-2---creamos-100000-clientes-de-ejemplo">Paso 2 - Creamos 100.000 clientes de ejemplo</h4>
<p>Al igual que hacíamos antes. Aquí podemos ver la primera diferencia, ya que usamos uno de los nuevos métodos TryXXX:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">Customer</span><span class="p">.</span><span class="n">GetSampleCustomers</span><span class="p">(</span><span class="m">100000</span><span class="p">).</span><span class="n">ForEach</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">dic2</span><span class="p">.</span><span class="n">TryAdd</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">CustomerId</span><span class="p">,</span> <span class="n">c</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div>
<h4 id="paso-3---modificamos-los-2-métodos-que-compiten">Paso 3 - Modificamos los 2 métodos que compiten</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">void</span> <span class="n">DeleteItem2</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Customer</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(!</span><span class="n">dic2</span><span class="p">.</span><span class="n">TryRemove</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">out</span> <span class="n">c</span><span class="p">))</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Error deleting!&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="n">UpdateItem2</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Customer</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">dic2</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">out</span> <span class="n">c</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Error getting value&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">Customer</span> <span class="n">newc</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Customer</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">CustomerId</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">CustomerId</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">Age</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">Age</span> <span class="p">};</span>
        <span class="n">newc</span><span class="p">.</span><span class="n">Age</span><span class="p">++;</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">dic2</span><span class="p">.</span><span class="n">TryUpdate</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">newc</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Error updating!&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>En el borrado usamos el método TryRemove que necesita el id del elemento a eliminar, y en caso que lo elimine con éxito, devuelve True y el objeto eliminado en el segundo parámetro out (de salida) del método. En caso que no lo elimine devuelve False y el valor default del objeto a eliminar en el segundo parámetro.</p>
<p>La actualización es un poco más compleja, ya que primero debemos asegurarnos de que el elemento a modificar existe en la colección mediante el método TryGetValue, que básicamente funciona igual que el método TryDelete anterior. Una vez hemos comprobado que dicho objeto existe en la colección creamos una réplica del cliente, modificamos su edad y llamamos al método TryUpdate, el cual se encarga de la modificación.</p>
<p>Es interesante notar que para que la modificación se realice correctamente debemos informar de la clave del objeto en la colección, el nuevo valor del objeto (en este caso la réplica del cliente a la que hemos modificado la edad) y un tercer parámetro que es el valor original del objeto, que es usado para comparar.</p>
<h4 id="paso-4---a-jugar-de-nuevo-d">Paso 4 - A jugar de nuevo :D</h4>
<p>Ejecutamos y si vamos a la ventana de consola podremos observar el resultado:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-systemd" data-lang="systemd"><span class="err">Error</span> <span class="err">getting</span> <span class="err">value</span>
<span class="err">Error</span> <span class="err">getting</span> <span class="err">value</span>
<span class="err">Error</span> <span class="err">getting</span> <span class="err">value</span>
<span class="err">Error</span> <span class="err">getting</span> <span class="err">value</span>
<span class="err">Error</span> <span class="err">updating!</span>
<span class="err">Error</span> <span class="err">getting</span> <span class="err">value</span>
<span class="err">Error</span> <span class="err">getting</span> <span class="err">value</span>
<span class="err">Error</span> <span class="err">getting</span> <span class="err">value</span></code></pre></td></tr></table>
</div>
</div>
<p>En la mayoría de los casos, obtenemos un error de lectura porque el elemento ya ha sido eliminado de la colección, pero en algunos casos el error se producirá en el método TryUpdate. Eso significa que la llamada a TryGetValue encuentra el elemento, pero cuando lo vamos a modificar éste ya no existe en la colección. Perfecto! :)</p>
<h3 id="conclusión">Conclusión</h3>
<p>La ventaja de usar colecciones específicas en entornos multithreading es clara: Garantizan que el acceso a los recursos compartidos sea transaccional, al más puro estilo de las bases de datos. De acuerdo que su programación sea un poco más compleja, pero no tiene nada que ver con lo que se tenía que hacer antiguamente cuando no existía la TPL.</p>
<p>Por otro lado, el uso de estas colecciones debe hacerse sólo en aquelos casos en los que se accede a recursos compartidos, ya que si no, por un lado estamos complicando nuestro codigo y por otro lado un ConcurrentDictionary no es tan eficiente como lo és un Dictionary, sobre todo en entornos más de escritura que de lectura. Tenéis un post muy detallado al respecto del gran James (aka Black Rabbit) respecto a la diferencia de performance:</p>
<p><a href="http://geekswithblogs.net/BlackRabbitCoder/archive/2010/06/09/c-4-the-curious-concurrentdictionary.aspx">http://geekswithblogs.net/BlackRabbitCoder/archive/2010/06/09/c-4-the-curious-concurrentdictionary.aspx</a></p>
<p>Espero sacar tiempo para otro post en el que explicar otras colecciones de este namespace, como las ‘BlockingCollection’ o las ‘’ConcurrentBag’, que son colecciones más especializadas. La primera está optimizada para escenarios dónde el mismo thread produce y consume objetos, mientras que la segunda ha sido especialmente diseñada para escenarios de productor-consumidor.</p>
<p><a href="/es/parallelseries00-index" rel="">Ir al índice de la serie</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Actualizado el 2013-03-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/es/parallelseries07-problemas-de-concurrencia/index.md" target="_blank">Leer Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Compartir en Twitter" data-sharer="twitter" data-url="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/" data-title="Parallel Series 07 - Problemas de concurrencia" data-via="lluisfranco" data-hashtags="csharp,net framework,Task,Parallel,Async"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Facebook" data-sharer="facebook" data-url="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/" data-hashtag="csharp"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Linkedin" data-sharer="linkedin" data-url="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en WhatsApp" data-sharer="whatsapp" data-url="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/" data-title="Parallel Series 07 - Problemas de concurrencia" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Pinterest" data-sharer="pinterest" data-url="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/" data-image="/images/posts/Concurrence.png"><i class="fab fa-pinterest fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Reddit" data-sharer="reddit" data-url="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Instapaper" data-sharer="instapaper" data-url="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/" data-title="Parallel Series 07 - Problemas de concurrencia" data-description=""><i data-svg-src="/lib/simple-icons/icons/instapaper.min.svg"></i></a><a href="javascript:void(0);" title="Compartir en Pocket" data-sharer="pocket" data-url="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/"><i class="fab fa-get-pocket fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Evernote" data-sharer="evernote" data-url="https://lluisfranco.com/es/parallelseries07-problemas-de-concurrencia/" data-title="Parallel Series 07 - Problemas de concurrencia"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/es/tags/csharp/">csharp</a>,&nbsp;<a href="/es/tags/net-framework/">net framework</a>,&nbsp;<a href="/es/tags/task/">Task</a>,&nbsp;<a href="/es/tags/parallel/">Parallel</a>,&nbsp;<a href="/es/tags/async/">Async</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Regresar</a></span>&nbsp;|&nbsp;<span><a href="/es/">Inicio</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/es/parallelseries06-task-class/" class="prev" rel="prev" title="Parallel Series 06 - Tasks, la 8ª maravilla"><i class="fas fa-angle-left fa-fw"></i>Parallel Series 06 - Tasks, la 8ª maravilla</a>
            <a href="/es/dotnet-spain-conference-2015/" class="next" rel="next" title="DotNet Spain Conference 2015">DotNet Spain Conference 2015<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lluisfrancoblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a><div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/about/" target="_blank">lluís</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Volver arriba">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="Ver comentarios">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.es.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copiar al portapapeles","maxShownLines":20},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/es/index.json","lunrLanguageCode":"es","maxResultLength":10,"noResultsFound":"No se encontraron resultados","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
